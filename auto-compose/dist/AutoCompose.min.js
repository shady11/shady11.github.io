!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.AutoCompose=t()}(this,function(){"use strict";var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e=function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e};function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function r(e,t,n){if(t="autosuggest_"+t,void 0===n)return void 0!==(n=e.dataset[t])?JSON.parse(e.dataset[t]):n;e.dataset[t]=JSON.stringify(n)}function S(e,t){var n=void 0;if(e.nextSibling)n=e.nextSibling;else{for(n=e.parentNode;n!==t&&!n.nextSibling;)n=n.parentNode;if(!n||n===t)return;n=n.nextSibling}return A(n)}function C(e,t){var n=void 0;if(e.previousSibling)n=e.previousSibling;else{for(n=e.parentNode;n!==t&&!n.previousSibling;)n=n.parentNode;if(!n||n===t)return;n=n.previousSibling}return N(n)}function E(e){return e.tagName&&"BR"===e.tagName?"\n":e.nodeValue||""}function w(e){var t=window.getSelection(),n=document.createRange();e(n),t.removeAllRanges(),t.addRange(n)}var t=[].concat(["fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing","tabSize","MozTabSize","whiteSpace","wordWrap","wordBreak"],["direction","boxSizing","borderRightWidth","borderLeftWidth","paddingRight","paddingLeft"]),A=([].concat(function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}(t),["width","overflowX","overflowY","borderTopWidth","borderBottomWidth","borderStyle","paddingTop","paddingBottom","lineHeight"]),function(e){for(var t=e;t.firstChild;)t=t.firstChild;return t}),N=function(e){for(var t=e;t.lastChild;)t=t.lastChild;return t};function u(e){var o=this;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,u),!e)throw Error("AutoCompose: Missing required parameter, options");"function"==typeof e&&(e={composer:e}),this.inputs=[],this.onChange=e.onChange||Function.prototype,this.onReject=e.onReject||Function.prototype,function(t,n,e){[].concat(e).forEach(function(e){if(void 0===n[e])throw Error("AutoCompose: Missing required parameter, "+t+"."+e)})}("AutoCompose",e,"composer"),function(n,e,o,r){[].concat(e[o]).forEach(function(e){var t=void 0===e?"undefined":a(e);if(t!==r&&"undefined"!==t)throw new TypeError("AutoCompose: Invalid Type for "+n+"."+o+", expected "+r)})}("AutoCompose",e,"composer","function"),this.composer=e.composer;function r(e){var t=m.parentNode;t.removeChild(m),e&&t.normalize(),m=g=h=null}function d(e){var t=m.firstChild.nodeValue;m.parentNode.insertBefore(m.firstChild,m);var n=m.previousSibling;o.onChange.call(h,{suggestion:g,acceptedSuggestion:t}),r(),e||w(function(e){e.setStartAfter(n),e.setEndAfter(n)})}function c(){o.onReject.call(h,{suggestion:g}),r()}function p(e){return e.parentNode===m}var y=this,v=!1,h=null,m=null,g=null;this.onBlurHandler=function(){return m&&r(!0)},this.onKeyDownHandler=function(e){m&&(9!==e.keyCode&&39!==e.keyCode&&40!==e.keyCode||(d(),v=!0,e.preventDefault()))};var b=0;this.onKeyUpHandler=function(e){var r=this;if("keyup"===e.type&&v)v=!1;else{var t=function(){var e=window.getSelection();if(!e.isCollapsed)return{};var t=e.getRangeAt(0),n=t.startContainer,o=t.startOffset;if(n.nodeType!==n.TEXT_NODE)try{n=A(n.childNodes[o]),o=0}catch(e){try{o=(n=N(n.childNodes[o-1])).nodeValue?n.nodeValue.length:null}catch(e){}}return{node:n,offset:o}}(),i=t.node,a=t.offset;if(!i)return m&&c();var n=p(i);if("mouseup"===e.type&&m){if(n&&a)return i.nodeValue=i.nodeValue.slice(0,a),d();if(function(e){for(;(e=C(e,h))&&!p(e););return!!e}(i))return d(!0)}if(n)try{i=C(m,this),a=i.nodeValue.length}catch(e){i=S(m,this),a=0}if(m&&c(),i.nodeType===i.TEXT_NODE){var o=i.nodeValue.slice(a);if(!o.trim()){for(var u=i;u=S(u,this);)if((o+=E(u)).trim())return;var f,l="";l=i.nodeValue.slice(0,a);for(var s=i;s=C(s,this);)l=E(s)+l;f=++b,y.composer.call(r,l,function(e){if(e&&f===b){h=r;var t=i.nodeValue.slice(a),n=i.parentNode,o=i.nextSibling;i.nodeValue=i.nodeValue.slice(0,a),n.insertBefore(document.createTextNode(t),o),(m=function(e){var t=document.createElement("div");return t.innerHTML=e.trim(),t.firstChild}("<span>"+(g=e)+"</span>")).style.opacity=.7,m.id="___autocompose_inline_suggestion___",n.insertBefore(m,o),w(function(e){e.setStartBefore(m),e.setEndBefore(m)})}})}}}};for(var t=arguments.length,n=Array(1<t?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];this.addInputs.apply(this,n)}return e(u,[{key:"addInputs",value:function(){for(var t=this,e=arguments.length,n=Array(e),o=0;o<e;o++)n[o]=arguments[o];Array.prototype.concat.apply([],n.map(function(e){return e[0]?Array.prototype.slice.call(e,0):e})).forEach(function(e){if(!e.isContentEditable)throw Error("AutoCompose: Invalid input: only contenteditable elements are supported");e.addEventListener("blur",t.onBlurHandler),e.addEventListener("keyup",t.onKeyUpHandler),e.addEventListener("mouseup",t.onKeyUpHandler),e.addEventListener("keydown",t.onKeyDownHandler,!0),r(e,"index",t.inputs.push(e)-1)})}},{key:"removeInputs",value:function(){for(var n=this,e=arguments.length,t=Array(e),o=0;o<e;o++)t[o]=arguments[o];Array.prototype.concat.apply([],t.map(function(e){return e[0]?Array.prototype.slice.call(e,0):e})).forEach(function(e){var t=r(e,"index");isNaN(t)||(n.inputs.splice(t,1),e.removeEventListener("blur",n.onBlurHandler),e.removeEventListener("keyup",n.onKeyUpHandler),e.removeEventListener("mouseup",n.onKeyUpHandler),e.removeEventListener("keydown",n.onKeyDownHandler,!0))})}},{key:"destroy",value:function(){this.removeInputs(this.inputs)}}]),u});
